name: Batch Process Files with OCR

on:
  workflow_dispatch:
    inputs:
      file_type:
        description: 'Choose file type to process'
        required: true
        type: choice
        options:
          - pdf
          - image
      additional_param:  
        description: 'Additional parameter(s)'
        required: false
        default: -l tha+eng

permissions:
  contents: write

jobs:
  process_files:
    runs-on: ubuntu-latest
    env:
      INPUT_DIR: ./input
      OUTPUT_DIR: ./output

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get files to process
      id: get-files
      run: |
        case "${{ github.event.inputs.file_type }}" in
          pdf)
            find $INPUT_DIR -maxdepth 1 -iname '*.pdf' -printf '%f\n' > filelist.txt
            ;;
          image)
            find $INPUT_DIR -maxdepth 1 \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.tiff' -o -iname '*.bmp' \) -printf '%f\n' > filelist.txt
            ;;
        esac
        echo "files=$(base64 -w0 filelist.txt)" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ocrmypdf
        # Keep original language handling logic

    - name: Create output directory
      run: mkdir -p $OUTPUT_DIR

    - name: Process files
      env:
        FILE_LIST: ${{ steps.get-files.outputs.files }}
      run: |
        echo "$FILE_LIST" | base64 --decode > filelist.txt
        while IFS= read -r filename; do
          [ -z "$filename" ] && continue
          
          ext="${filename##*.}"
          timestamp=$(date +"%Y%m%d_%H%M%S")
          base="${filename%.*}"

          case "${{ github.event.inputs.file_type }}" in
            pdf)
              ocrmypdf ${{ github.event.inputs.additional_param }} --skip-text --clean \
                --sidecar "$OUTPUT_DIR/${base}_${timestamp}.txt" \
                "$INPUT_DIR/$filename" "$OUTPUT_DIR/${base}_${timestamp}.pdf"
              ;;
            image)
              tesseract ${{ github.event.inputs.additional_param }} "$INPUT_DIR/$filename" \
                "$OUTPUT_DIR/${base}_${timestamp}" pdf txt
              ;;
          esac

          # Cleanup processed file
          git rm "$INPUT_DIR/$filename"
          rm -f "$INPUT_DIR/$filename"
        done < filelist.txt

    - name: Commit changes
      run: |
        git config --local user.name "github-actions"
        git config --local user.email "github-actions@github.com"
        git add -A
        git commit -m "Processed ${{ github.event.inputs.file_type }} files"
        git push

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: processed-files
        path: $OUTPUT_DIR/*
        retention-days: 7
