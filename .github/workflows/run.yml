name: Process PDF with OCRmyPDF

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Input PDF file name from /input/ folder'
        required: true

permissions:
  contents: write

jobs:
  process_pdf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache APT Packages
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt
          /var/lib/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Cache OCRmyPDF and Tesseract
      uses: actions/cache@v3
      with:
        path: |
          /usr/bin/ocrmypdf
          /usr/bin/tesseract
        key: ${{ runner.os }}-ocrmypdf-tesseract-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-ocrmypdf-tesseract-

    - name: Install OCRmyPDF and Tesseract
      run: |
        sudo apt-get update
        sudo apt-get install -y ocrmypdf
        sudo apt-get install -y tesseract-ocr-tha

    - name: Cache APT Packages Post Run
      if: always()
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt
          /var/lib/apt
        key: ${{ steps.cache-apt.outputs.cache-hit != 'true' && runner.os }}-apt-${{ hashFiles('**/requirements.txt') }}

    - name: Cache OCRmyPDF and Tesseract Post Run
      if: always()
      uses: actions/cache@v3
      with:
        path: |
          /usr/bin/ocrmypdf
          /usr/bin/tesseract
        key: ${{ steps.cache-ocr-tesseract.outputs.cache-hit != 'true' && runner.os }}-ocrmypdf-tesseract-${{ hashFiles('**/requirements.txt') }}

    - name: Process PDF
      run: |
        ocrmypdf -l tha+eng --clean --sidecar ./input/output_OCRmyPDF.txt ./input/${{ github.event.inputs.input_file }} ./input/output_OCRmyPDF.pdf
    # https://ocrmypdf.readthedocs.io/en/latest/cookbook.html

    - name: Upload output PDF
      uses: actions/upload-artifact@v4
      with:
        name: output-pdf
        path: |
          ./input/output_OCRmyPDF.pdf
          ./input/output_OCRmyPDF.txt
        retention-days: 7
